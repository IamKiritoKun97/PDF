<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAMON TARIAO PDF Editor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- jsPDF for saving -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #525659;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow: hidden;
            margin: 0;
        }

        #toolbar {
            background-color: #ffffff;
            border-bottom: 1px solid #d1d1d1;
            height: 48px;
            z-index: 100;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            padding: 0 10px;
            border-radius: 4px;
            color: #333;
            transition: all 0.15s;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 13.5px;
            font-weight: 400;
        }

        .tool-btn:hover { background-color: #f3f3f3; }
        .tool-btn.active {
            background-color: #e5f1fb;
            color: #005a9e;
        }

        .divider { height: 20px; width: 1px; background-color: #d1d1d1; margin: 0 10px; }

        #main-container {
            height: calc(100vh - 48px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            scroll-behavior: smooth;
        }

        .pdf-page-container {
            position: relative;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
            background: white;
        }

        .pdf-canvas { display: block; }

        .annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            touch-action: none;
        }

        .text-input-box {
            position: absolute;
            background: transparent;
            border: 1px dashed #005a9e;
            padding: 2px;
            min-width: 100px;
            outline: none;
            color: inherit;
            font-family: sans-serif;
            font-size: 16px;
            z-index: 50;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 44px;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            padding: 12px;
            z-index: 200;
            width: 180px;
        }

        .color-swatch {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px #ccc;
        }
        .color-swatch.selected { box-shadow: 0 0 0 2px #005a9e; }

        #drag-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 90, 158, 0.8);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #005a9e;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body id="drop-zone">

    <div id="drag-overlay">
        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
        <span class="text-xl font-bold">Drop to Open PDF</span>
    </div>

    <header id="toolbar" class="flex items-center px-4 select-none fixed top-0 w-full">
        <div class="font-bold text-gray-800 mr-6 tracking-tighter text-lg hidden md:block border-r pr-5 border-gray-300">
            RAMON TARIAO
        </div>

        <div class="flex items-center gap-1">
            <input type="file" id="file-input" accept="application/pdf" class="hidden">
            <button onclick="document.getElementById('file-input').click()" class="tool-btn" title="Open PDF">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/></svg>
                <span class="ml-2 hidden sm:block">Open</span>
            </button>
            <button id="save-btn" class="tool-btn" title="Save Edited PDF">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                <span class="ml-2 hidden sm:block">Save</span>
            </button>
        </div>

        <div class="divider"></div>

        <div class="flex items-center gap-1">
            <button id="text-tool" class="tool-btn" title="Add Text">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                <span class="ml-2 hidden lg:block">Add Text</span>
            </button>

            <div class="relative">
                <button id="draw-tool" class="tool-btn" title="Draw">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    <span class="ml-2 hidden lg:block">Draw</span>
                    <svg onclick="event.stopPropagation(); toggleMenu('draw')" class="ml-1 w-3 h-3 text-gray-400 hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                </button>
                <div id="draw-menu" class="dropdown-menu">
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Ink Color</p>
                    <div class="flex gap-2 mb-4">
                        <div class="color-swatch selected bg-black" onclick="setColor('draw', '#000', this)"></div>
                        <div class="color-swatch bg-red-600" onclick="setColor('draw', '#dc2626', this)"></div>
                        <div class="color-swatch bg-blue-600" onclick="setColor('draw', '#2563eb', this)"></div>
                        <div class="color-swatch bg-green-600" onclick="setColor('draw', '#16a34a', this)"></div>
                    </div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Size</p>
                    <input type="range" min="1" max="12" value="2" id="draw-width" class="w-full cursor-pointer">
                </div>
            </div>

            <div class="relative">
                <button id="highlight-tool" class="tool-btn" title="Highlight">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
                    <span class="ml-2 hidden lg:block">Highlight</span>
                    <svg onclick="event.stopPropagation(); toggleMenu('highlight')" class="ml-1 w-3 h-3 text-gray-400 hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                </button>
                <div id="highlight-menu" class="dropdown-menu">
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Color</p>
                    <div class="flex gap-2 mb-4">
                        <div class="color-swatch selected bg-yellow-300" onclick="setColor('highlight', '#fde047', this)"></div>
                        <div class="color-swatch bg-green-300" onclick="setColor('highlight', '#86efac', this)"></div>
                        <div class="color-swatch bg-blue-300" onclick="setColor('highlight', '#93c5fd', this)"></div>
                        <div class="color-swatch bg-pink-300" onclick="setColor('highlight', '#f9a8d4', this)"></div>
                    </div>
                    <input type="range" min="10" max="40" value="20" id="highlight-width" class="w-full cursor-pointer">
                </div>
            </div>

            <button id="erase-tool" class="tool-btn" title="Eraser">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
                <span class="ml-2 hidden lg:block">Eraser</span>
            </button>
            
            <div class="divider"></div>

            <button id="clear-page-btn" class="tool-btn text-red-600 hover:bg-red-50" title="Clear Page">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                <span class="ml-2 hidden lg:block">Clear Page</span>
            </button>
        </div>

        <div class="flex-grow"></div>
        <div id="page-count" class="text-xs text-gray-400 font-medium tracking-tight"></div>
    </header>

    <main id="main-container">
        <div id="empty-state" class="flex flex-col items-center justify-center mt-32 text-gray-400">
            <svg class="w-20 h-20 mb-6 opacity-20" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
            <h2 class="text-lg font-medium text-white opacity-80 mb-4">No PDF loaded</h2>
            <button onclick="document.getElementById('file-input').click()" class="bg-[#005a9e] text-white px-8 py-2.5 rounded-sm text-sm font-semibold hover:bg-[#004a83]">Open File</button>
        </div>

        <div id="pdf-loader" class="hidden flex flex-col items-center mt-32">
            <div class="loader mb-4"></div>
            <p class="text-gray-300 text-sm">Rendering PDF pages...</p>
        </div>

        <div id="pdf-wrapper" class="w-full flex flex-col items-center hidden"></div>
    </main>

    <script>
        const state = {
            pdfDoc: null,
            scale: 1.5,
            currentTool: 'cursor',
            colors: { draw: '#000000', highlight: '#fde047' },
            widths: { draw: 2, highlight: 20 },
            isDrawing: false,
            activeInput: null 
        };

        const wrapper = document.getElementById('pdf-wrapper');
        const emptyState = document.getElementById('empty-state');
        const loader = document.getElementById('pdf-loader');
        const fileInput = document.getElementById('file-input');
        const drawMenu = document.getElementById('draw-menu');
        const highMenu = document.getElementById('highlight-menu');

        const toolBtns = {
            text: document.getElementById('text-tool'),
            draw: document.getElementById('draw-tool'),
            highlight: document.getElementById('highlight-tool'),
            erase: document.getElementById('erase-tool')
        };

        function setTool(t) {
            if (state.activeInput) finalizeText(state.activeInput);
            
            state.currentTool = t;
            Object.keys(toolBtns).forEach(k => {
                toolBtns[k].classList.toggle('active', k === t);
            });
            document.querySelectorAll('.annotation-canvas').forEach(c => {
                c.style.cursor = t === 'text' ? 'text' : 'crosshair';
            });
            closeMenus();
        }

        function toggleMenu(type) {
            const menu = type === 'draw' ? drawMenu : highMenu;
            const isVisible = menu.style.display === 'block';
            closeMenus();
            if (!isVisible) menu.style.display = 'block';
        }

        function closeMenus() {
            drawMenu.style.display = 'none';
            highMenu.style.display = 'none';
        }

        function setColor(tool, color, el) {
            state.colors[tool] = color;
            el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
        }

        fileInput.onchange = (e) => loadPDF(e.target.files[0]);
        
        window.ondragover = (e) => { e.preventDefault(); document.getElementById('drag-overlay').style.display = 'flex'; };
        document.getElementById('drag-overlay').ondragleave = () => { document.getElementById('drag-overlay').style.display = 'none'; };
        document.getElementById('drag-overlay').ondrop = (e) => {
            e.preventDefault();
            document.getElementById('drag-overlay').style.display = 'none';
            if (e.dataTransfer.files[0]) loadPDF(e.dataTransfer.files[0]);
        };

        async function loadPDF(file) {
            if (!file || file.type !== 'application/pdf') return;
            emptyState.style.display = 'none';
            wrapper.innerHTML = '';
            loader.classList.remove('hidden');

            const data = await file.arrayBuffer();
            state.pdfDoc = await pdfjsLib.getDocument({data}).promise;
            document.getElementById('page-count').innerText = `${state.pdfDoc.numPages} Pages`;

            for (let i = 1; i <= state.pdfDoc.numPages; i++) {
                await renderPage(i);
            }
            loader.classList.add('hidden');
            wrapper.classList.remove('hidden');
            setTool('draw'); 
        }

        async function renderPage(num) {
            const page = await state.pdfDoc.getPage(num);
            const viewport = page.getViewport({scale: state.scale});

            const container = document.createElement('div');
            container.className = 'pdf-page-container';
            container.style.width = viewport.width + 'px';
            container.style.height = viewport.height + 'px';

            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-canvas';
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const annCanvas = document.createElement('canvas');
            annCanvas.className = 'annotation-canvas';
            annCanvas.width = viewport.width;
            annCanvas.height = viewport.height;

            container.appendChild(canvas);
            container.appendChild(annCanvas);
            wrapper.appendChild(container);

            await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
            setupInteraction(annCanvas);
        }

        function setupInteraction(canvas) {
            const ctx = canvas.getContext('2d');
            let lastX, lastY;

            canvas.onmousedown = (e) => {
                if (state.currentTool === 'text') {
                    handleTextClick(e, canvas);
                    return;
                }
                state.isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            };

            canvas.onmousemove = (e) => {
                if (!state.isDrawing) return;
                
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                if (state.currentTool === 'draw') {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = state.colors.draw;
                    ctx.lineWidth = state.widths.draw;
                    ctx.globalAlpha = 1;
                } else if (state.currentTool === 'highlight') {
                    ctx.globalCompositeOperation = 'multiply';
                    ctx.strokeStyle = state.colors.highlight;
                    ctx.lineWidth = state.widths.highlight;
                    ctx.globalAlpha = 0.5;
                } else if (state.currentTool === 'erase') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 20;
                    ctx.globalAlpha = 1;
                }

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            };

            window.addEventListener('mouseup', () => state.isDrawing = false);
        }

        function handleTextClick(e, canvas) {
            if (state.activeInput) {
                finalizeText(state.activeInput);
            }

            const x = e.offsetX;
            const y = e.offsetY;

            const input = document.createElement('div');
            input.contentEditable = "true";
            input.className = 'text-input-box';
            input.style.left = x + 'px';
            input.style.top = (y - 10) + 'px';
            input.style.color = state.colors.draw;
            
            input.dataset.x = x;
            input.dataset.y = y;

            canvas.parentElement.appendChild(input);
            state.activeInput = input;
            
            setTimeout(() => input.focus(), 10);

            input.onmousedown = (ev) => ev.stopPropagation();
            
            input.onblur = () => finalizeText(input);
            
            input.onkeydown = (ev) => {
                if (ev.key === 'Enter' && ev.ctrlKey) {
                    input.blur();
                }
            };
        }

        function finalizeText(input) {
            const text = input.innerText.trim();
            if (text) {
                const container = input.parentElement;
                const canvas = container.querySelector('.annotation-canvas');
                const ctx = canvas.getContext('2d');
                
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;
                ctx.fillStyle = input.style.color;
                ctx.font = "16px sans-serif";
                ctx.textBaseline = "top";
                
                const lines = text.split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, parseFloat(input.dataset.x), parseFloat(input.dataset.y) + (i * 20));
                });
            }
            input.remove();
            state.activeInput = null;
        }

        document.getElementById('clear-page-btn').onclick = () => {
            const containers = document.querySelectorAll('.pdf-page-container');
            containers.forEach(container => {
                const rect = container.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    const ctx = container.querySelector('.annotation-canvas').getContext('2d');
                    ctx.clearRect(0, 0, 10000, 10000);
                }
            });
        };

        document.getElementById('save-btn').onclick = async () => {
            if (!state.pdfDoc) return;

            // 1. Ensure any active text is finalized before saving
            if (state.activeInput) {
                finalizeText(state.activeInput);
            }

            const btn = document.getElementById('save-btn');
            const original = btn.innerHTML;
            btn.innerHTML = `<div class="loader" style="width:14px;height:14px"></div><span class="ml-2">Saving...</span>`;

            // Wait a frame for the finalization to render to the canvas
            await new Promise(resolve => requestAnimationFrame(resolve));

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'a4');
            const pages = document.querySelectorAll('.pdf-page-container');

            for (let i = 0; i < pages.length; i++) {
                const container = pages[i];
                const pdfC = container.querySelector('.pdf-canvas');
                const annC = container.querySelector('.annotation-canvas');

                const temp = document.createElement('canvas');
                temp.width = pdfC.width;
                temp.height = pdfC.height;
                const tCtx = temp.getContext('2d');
                
                // Layer original PDF and then annotations (which now include text)
                tCtx.drawImage(pdfC, 0, 0);
                tCtx.drawImage(annC, 0, 0);

                const imgData = temp.toDataURL('image/jpeg', 0.95);
                const pWidth = pdf.internal.pageSize.getWidth();
                const pHeight = (temp.height * pWidth) / temp.width;

                if (i > 0) pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, 0, pWidth, pHeight);
            }

            pdf.save('ramon_tariao_edited.pdf');
            btn.innerHTML = original;
        };

        toolBtns.text.onclick = () => setTool('text');
        toolBtns.draw.onclick = () => setTool('draw');
        toolBtns.highlight.onclick = () => setTool('highlight');
        toolBtns.erase.onclick = () => setTool('erase');
        
        document.getElementById('draw-width').oninput = (e) => state.widths.draw = e.target.value;
        document.getElementById('highlight-width').oninput = (e) => state.widths.highlight = e.target.value;

        window.onclick = (e) => {
            if (!e.target.closest('.relative')) closeMenus();
        };

    </script>
</body>
</html>

